<div class="title-card">
    <h1>Backup</h1>
</div>

---

# Take a PostgreSQL dump

Run `pg_dump` inside the container:

```bash
$ docker compose exec -T db pg_dump -U myuser mydatabase > pgdump.sql
```

*What does the file contain?*

<details> 
  <summary>Answer</summary>
   DDL, DML and DCL statements. Basically, everything needed to recreate the database.
</details>

---

# Restoring a PostgreSQL Database

Native ways to restore a PostgreSQL database.

This disregards changing `init.sql` or volumes.

1\. Restore from an SQL file with `<` pointing to the database. Try it out:

```bash:
$ docker compose exec -T db psql -U myuser mydatabase < pgdump.sql
```

2\. Create a formatted custom dump (with the `-Fc` flag) and use `pg_restore` command.

```bash
$ docker compose exec -T db pg_dump -U myuser -Fc mydatabase > dump.custom
$ docker compose exec -T db pg_restore -U myuser -d mydatabase < dump.custom
```

*What type of file is it?*

---

# Stop and restart the container

*Does the database persist?*

---

# Get a clean database

The data consists because it is defined in a volume.

Manually get a clean database by:

1. Stop the database. 

2. Delete the image first, then the volume. 

3. Restart the database.

4. [Optional] Verify that the database is empty.

Or use this single command to discard the volume:

```bash
$ docker compose down -v
```

---

# Create a new database and restore from the dump

Where the `docker-compose.yml` file is defined:

```bash
$ docker compose up
```

Then load from the dump into the database


```bash
$ PGPASSWORD=mypassword psql -U myuser -h 127.0.0.1 -d mydatabase < pgdump.sql
```

Check the database:

```bash
$ docker compose exec db psql -U myuser -d mydatabase
```

In the posgreSQL shell:

```sql
mydatabase=# \dt              # show tables
mydatabase=# \d <table_name>  # describe table
```

---

# Load the file when initializing the database

1. Create a folder `initdb` in the same directory as the `docker-compose.yml` file.

2. Move the `pgdump.sql` file to the `initdb` folder and rename it to `init.sql`.

3. Load the file as a volume. In `docker-compose.yml`:

    ```yaml
        volumes:
        - postgres_data:/var/lib/postgresql/data
        - ./initdb/init.sql:/docker-entrypoint-initdb.d/init.sql # new line
    ```

4. Take down the database and start it again:

    ```bash
    $ docker compose down -v
    $ docker compose up
    ```

---

# Take a MySQL dump

Similarly, `mysqldump` comes installed with MySQL. 

If you have MySQL installed locally then try it out on any database:

```bash
$ mysqldump -u <user> -p <database_name> > mysqldump.sql
```

---

<div class="title-card">
    <h1>MRO and documentation</h1>
</div>

---

# MRO

MRO: **M**odel **R**elations to **O**bjects

A tool that takes extracts the schema of an existing database and models it to various formats.

First, watch me give a full demo of all prompts outside of where the `.env.` is defined.

---

# Generate knex migrations from an existing schema

1\. The opposite of an ORM. It generates objects from an existing database.

```bash
$ npx mro
```

2\. Choose the prompt `Knex.js Migrations`.

Make sure to run it from where the `.env` file is defined to skip several prompts.

*Based on this slide, how do you think MRO can help you?*

<details> 
  <summary>Answer</summary>
   You have a schema in SQLite and want to convert it to PostgreSQL. MRO can create the Knex migrations for us. 
</details>

---

# MRO: Generate HTML documentation

MRO can also be used to generate HTML documentation.

1\. Run it:

```bash
$ npx mro
```

2\. Choose the prompt: `HTML documentation`.

**Tip**: All prompts can be autoskipped by defining the correct keys in a `.env` file as we have. This is useful for full automation in GitHub action etc..


---

# Generating database documentation

*Have you tried to document SQL databases before? How?*

*Can you imagine ways to document other types of databases?*

---

# Documenting databases

**Relational databases**: ER diagrams, in a text document

**NoSQL databases**: JSON schema, HTML

**Graph databases**: GraphML, Graphviz

And more...

